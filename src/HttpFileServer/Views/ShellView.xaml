<Window
    x:Class="HttpFileServer.Views.ShellView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:HttpFileServer.Controls"
    xmlns:converters="clr-namespace:HttpFileServer.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="clr-namespace:HttpFileServer.ViewModels"
    Title="{Binding Title, Mode=OneWay}"
    Width="800"
    Height="480"
    MinWidth="300"
    MinHeight="200"
    MaxWidth="800"
    MaxHeight="600"
    Background="{DynamicResource WindowBackgroundBrush}"
    FontSize="14"
    Foreground="{DynamicResource WindowForegroundBrush}"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Window.DataContext>
        <viewmodels:ShellViewModel />
    </Window.DataContext>
    <Window.Resources>
        <converters:BoolReverseConverter x:Key="boolReverse" />
        <!--  初始主题色（浅色），ViewModel 动态替换  -->
        <SolidColorBrush x:Key="WindowBackgroundBrush" Color="#FFFFFF" />
        <SolidColorBrush x:Key="WindowForegroundBrush" Color="#111111" />
        <!--  Ensure labels follow the current theme foreground for readability in dark mode  -->
        <Style TargetType="Label">
            <Setter Property="Foreground" Value="{DynamicResource WindowForegroundBrush}" />
        </Style>
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="{DynamicResource WindowForegroundBrush}" />
        </Style>
        <SolidColorBrush x:Key="PanelBackgroundBrush" Color="#F5F5F5" />
        <SolidColorBrush x:Key="PanelBorderBrush" Color="#DDDDDD" />
        <SolidColorBrush x:Key="AccentBrush" Color="#3B82F6" />
        <!--  按钮基础样式，防止深色主题下被默认模板改成白色高亮  -->
        <Style x:Key="BaseButton" TargetType="Button">
            <Setter Property="Foreground" Value="{DynamicResource WindowForegroundBrush}" />
            <Setter Property="Background" Value="{DynamicResource PanelBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource PanelBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="4,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="bd"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="{DynamicResource AccentBrush}" />
                                <Setter Property="Foreground" Value="White" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="{DynamicResource AccentBrush}" />
                                <Setter TargetName="bd" Property="Opacity" Value="0.85" />
                                <Setter Property="Foreground" Value="White" />
                            </Trigger>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="bd" Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!--  启动按钮强调样式  -->
        <Style
            x:Key="AccentButton"
            BasedOn="{StaticResource BaseButton}"
            TargetType="Button">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
            <Setter Property="Foreground" Value="White" />
        </Style>
        <!--  DataGrid主题  -->
        <Style x:Key="ThemedDataGrid" TargetType="DataGrid">
            <Setter Property="Background" Value="{DynamicResource PanelBackgroundBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource WindowForegroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource PanelBorderBrush}" />
            <Setter Property="HorizontalGridLinesBrush" Value="{DynamicResource PanelBorderBrush}" />
            <Setter Property="VerticalGridLinesBrush" Value="{DynamicResource PanelBorderBrush}" />
        </Style>
        <Style x:Key="ThemedDataGridHeader" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{DynamicResource PanelBorderBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource WindowForegroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource PanelBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="4,2" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridColumnHeader">
                        <Border
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                    <Setter Property="Foreground" Value="White" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>
    <Grid Margin="6" Background="{DynamicResource WindowBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="1*" />
        </Grid.RowDefinitions>
        <StackPanel Margin="0,0,0,4" Background="{DynamicResource PanelBackgroundBrush}">
            <Grid Margin="-5,2,0,2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="1*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Label VerticalContentAlignment="Center" Content="路径:" />
                <controls:PathSelector
                    Grid.Column="1"
                    Height="32"
                    VerticalAlignment="Center"
                    VerticalContentAlignment="Center"
                    IsEnabled="{Binding IsRunning, Converter={StaticResource boolReverse}}"
                    SelectedPath="{Binding SourceDir, Mode=TwoWay}" />
                <WrapPanel Grid.Column="2">
                    <Label
                        Height="30"
                        VerticalContentAlignment="Center"
                        Content="端口" />
                    <TextBox
                        x:Name="tbPort"
                        Width="50"
                        Height="30"
                        VerticalContentAlignment="Center"
                        Background="{DynamicResource PanelBackgroundBrush}"
                        BorderBrush="{DynamicResource PanelBorderBrush}"
                        Foreground="{DynamicResource WindowForegroundBrush}"
                        Text="{Binding ListenPort, UpdateSourceTrigger=PropertyChanged}" />
                </WrapPanel>
            </Grid>
            <Grid Margin="0,4">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox
                    x:Name="tbCurState"
                    Padding="15,0"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Background="{DynamicResource PanelBackgroundBrush}"
                    BorderThickness="0"
                    Foreground="{DynamicResource WindowForegroundBrush}"
                    IsReadOnly="True"
                    Text="{Binding ThemeMode, Mode=OneWay}" />
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <CheckBox
                        x:Name="ckAutoStart"
                        Margin="5,0"
                        VerticalAlignment="Center"
                        Content="开机自启"
                        IsChecked="{Binding AutoStartWithSystem, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource boolReverse}}"
                        ToolTip="开机后是否自动启动程序和服务" />
                    <CheckBox
                        x:Name="ckAutoStartWithMin"
                        Margin="5,0"
                        VerticalAlignment="Center"
                        Content="最小化"
                        IsChecked="{Binding MinimizeToTrayAfterAutoStart, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        IsEnabled="{Binding ElementName=ckAutoStart, Path=IsChecked}"
                        ToolTip="自启动后是否最小化窗口" />
                    <CheckBox
                        x:Name="ckAutoStartOnLaunch"
                        Margin="5,0"
                        VerticalAlignment="Center"
                        Content="服务自启"
                        IsChecked="{Binding AutoStartOnLaunch, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource boolReverse}}"
                        ToolTip="手动启动程序后，是否自动启动服务" />
                    <CheckBox
                        x:Name="ckAllowUpload"
                        Margin="5,0"
                        VerticalAlignment="Center"
                        Content="允许上传"
                        IsChecked="{Binding EnableUpload, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource boolReverse}}" />
                    <CheckBox
                        x:Name="ckWebMode"
                        Margin="5,0"
                        VerticalAlignment="Center"
                        Content="静态Web"
                        IsChecked="{Binding UseWebServer, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource boolReverse}}"
                        ToolTip="启用后以静态 Web 服务器模式运行（优先返回 index.html、使用真实 MIME 类型）" />
                </StackPanel>
                <WrapPanel Grid.Column="2">
                    <Button
                        x:Name="btnRun"
                        Width="70"
                        Height="30"
                        Margin="5,0"
                        Command="{Binding CommandStartServer}"
                        Content="启动"
                        Style="{StaticResource AccentButton}" />
                    <Button
                        x:Name="BtnStop"
                        Width="70"
                        Height="30"
                        Command="{Binding CommandStopServer}"
                        Content="停止"
                        Foreground="{DynamicResource WindowForegroundBrush}"
                        Style="{StaticResource BaseButton}" />
                </WrapPanel>
                <Button
                    Grid.Column="3"
                    Width="70"
                    Height="30"
                    Margin="5,0"
                    Command="{Binding CommandToggleTheme}"
                    Content="切换主题"
                    Foreground="{DynamicResource WindowForegroundBrush}"
                    Style="{StaticResource BaseButton}" />
            </Grid>
        </StackPanel>
        <Border
            Grid.Row="1"
            Height="100"
            Background="{DynamicResource PanelBackgroundBrush}"
            BorderBrush="{DynamicResource PanelBorderBrush}"
            BorderThickness="1">
            <DataGrid
                AutoGenerateColumns="False"
                ColumnHeaderStyle="{StaticResource ThemedDataGridHeader}"
                ItemsSource="{Binding RequestModels}"
                Style="{StaticResource ThemedDataGrid}">
                <DataGrid.Columns>
                    <DataGridTextColumn
                        Width="100"
                        Binding="{Binding EndPoint}"
                        Header="来源节点" />
                    <DataGridTextColumn
                        Width="80"
                        Binding="{Binding HttpMethod}"
                        Header="请求方法" />
                    <DataGridTextColumn
                        Width="1*"
                        Binding="{Binding RequestUrl}"
                        Header="请求地址" />
                    <DataGridTextColumn
                        Width="80"
                        Binding="{Binding Status}"
                        Header="状态" />
                </DataGrid.Columns>
            </DataGrid>
        </Border>
        <Border
            Grid.Row="2"
            VerticalAlignment="Stretch"
            Background="{DynamicResource PanelBackgroundBrush}"
            BorderBrush="{DynamicResource PanelBorderBrush}"
            BorderThickness="1">
            <TextBox
                x:Name="logs"
                Background="{DynamicResource PanelBackgroundBrush}"
                Foreground="{DynamicResource WindowForegroundBrush}"
                IsReadOnly="True"
                ScrollViewer.HorizontalScrollBarVisibility="Auto"
                ScrollViewer.VerticalScrollBarVisibility="Auto"
                Text="{Binding Path=LogContent, Mode=OneWay}" />
        </Border>
    </Grid>
</Window>