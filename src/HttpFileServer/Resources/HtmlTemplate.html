<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HttpFileServer</title>
    <script src="/qrcode.min.js?type=resource"></script>
    <script src="/tailwindcss.3.4.17.js?type=resource"></script>
    <link rel="stylesheet" href="/appstyle.css?type=resource" />
    <title id="title">{{title}}</title>
</head>

<body class="min-h-screen">
    <!--头部导航 -->
    <header class="h-16 shadow-sm border-b">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-primary">{{header}}</h1>
                </div>
            </div>
        </div>
    </header>

    <div class="h-[calc(100vh-128px)] w-full px-4 sm:px-6 lg:px-8 py-8">
        <!-- 文件操作区域 -->
        <div class="h-full theme-panel rounded-lg shadow-sm">
            <!--视图切换区域 -->
            <div id="fileContainer" class="h-full p-6 relative flex flex-col">
                <!-- 表格视图 -->
                <div id="tableViewContent" class="table-container flex-auto h-full mb-4">
                    <table class="min-w-full divide-y" style="border-color:var(--panel-border)">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">大小</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">修改日期</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">类型</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y" style="border-color:var(--panel-border)">
                            {{tableRows}}
                        </tbody>
                    </table>
                </div>
                <!-- 概览信息 -->
                <div class="flex-none">
                    <span class="text-sm text-secondary">总计: {{itemcount}} 个项目</span>
                </div>
            </div>
        </div>
    </div>
    <!-- 底部导航 -->
    <footer class="flex justify-center pb-8">
        <div class="flex items-center space-x-2 text-secondary">{{footer}}</div>
    </footer>

    <!-- 悬停预览浮层 -->
    <div id="previewPopover" class="hidden"></div>

    <!-- 修改后的预览模态框 -->
    <div id="previewModal" class="hidden">
        <div id="previewModalInner" class="rounded-xl">
            <div class="px-4 py-2 border-b flex items-center space-x-2">
                <button id="prevBtn" class="px-2 py-1 text-xs border rounded disabled:opacity-30" onclick="previewPrev()">
                    ◀
                </button>
                <button id="nextBtn" class="px-2 py-1 text-xs border rounded disabled:opacity-30" onclick="previewNext()">
                    ▶
                </button>
                <h3 id="previewTitle" class="text-sm font-semibold text-gray-900 flex-1 truncate">文件预览</h3>
                <button id="closePreview" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="closePreview()">关闭</button>
            </div>
            <div class="p-4">
                <div id="previewContent" class="flex justify-center"></div>
                <div id="shareText" class="mt-3 text-sm text-secondary break-words text-center"></div>
            </div>
        </div>
    </div>

    <!--主题切换按钮（固定右下角） -->
    <button id="themeToggle" class="theme-toggle-btn" type="button">切换主题</button>
    {{uploadSection}}
    <script>
        //主题初始化与切换
        const root = document.documentElement;
        const savedTheme = localStorage.getItem('webTheme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(mode) {
            root.setAttribute('data-theme', mode);
        }
        applyTheme(savedTheme ? savedTheme : (prefersDark.matches ? 'dark' : 'light'));
        prefersDark.addEventListener('change', e => {
            if (!localStorage.getItem('webTheme')) applyTheme(e.matches ? 'dark' : 'light');
        });
        document.getElementById('themeToggle').addEventListener('click', () => {
            const cur = root.getAttribute('data-theme');
            const next = cur === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem('webTheme', next);
        });

        // ===== 原有脚本保持 =====
        let files = [];
        const mainBody = document.querySelector('body');
        const uploadManager = new UploadManager();
        let previewFileNames = [];
        let currentPreviewIndex = -1;

        mainBody.addEventListener("dragover", e => e.preventDefault());
        mainBody.addEventListener("dragleave", e => e.preventDefault());
        mainBody.addEventListener("drop", dropHandle);

        async function dropHandle(event) {
            event.preventDefault();
            const promises = [];

            for (const item of event.dataTransfer.items) {
                const entry = item.webkitGetAsEntry();
                promises.push(readFiles(entry));
            }

            const resultFilesArrays = await Promise.all(promises);
            files = resultFilesArrays.flat().reverse();

            let dataStr = files.map(file => `
                 <tr class='row-hover transition-colors'>
                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${file.fullPath}</td>
                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${getFileSize(file.size)}</td>
                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${formatDate(file.lastModifiedDate)}</td>
                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary uploadStatus'>待上传</td>
                 </tr>
                 `).join('');

            document.querySelector("#fileInfo").innerHTML = dataStr;
            const overview = document.getElementById('overview')
            overview.innerText = `文件总数：${files.length}`

            document.querySelector("#confirm").classList.add("hidden");
            document.querySelector("#cancel").classList.remove("hidden");
            document.querySelector("#uploader").classList.remove("hidden");
            document.querySelector("#uploadModal").classList.remove("hidden");
        }
        //读取文件/文件夹
        async function readFiles(item) {
            if (item.isDirectory) {
                // 是一个文件夹
                const directoryReader = item.createReader();
                // readEntries是一个异步方法
                const entries = await new Promise((resolve, reject) => {
                    directoryReader.readEntries(resolve, reject);
                });

                let files = [];
                for (const entry of entries) {
                    const resultFiles = await readFiles(entry);
                    files = files.concat(resultFiles);
                }
                return files;
            } else {
                // 是一个文件
                const file = await new Promise((resolve, reject) => {
                    item.file(resolve, reject);
                });
                file.fullPath = item.fullPath;
                return [file];
            }
        }

        async function sendFiles() {
            if (!files.length) return;
            document.querySelector("#confirm").classList.add("hidden");
            document.querySelector("#cancel").classList.remove("hidden");
            document.querySelector("#uploader").classList.add("hidden");
            const statusBoxs = Array.from(document.querySelectorAll(".uploadStatus"));
            const fileItems = statusBoxs.map((e, i) => {
                return {
                    file: files[i],
                    progressEle: e,
                };
            });

            await uploadManager.addFiles(fileItems);
            uploadManager.queue.getStatus();
            uploadManager.queue.startTask();
            uploadManager.onComplete = (summary) => {
                files = [];
                document.querySelector("#confirm").classList.remove("hidden");
                document.querySelector("#cancel").classList.add("hidden");
                document.querySelector("#uploader").classList.add("hidden");
            };
        }

        function cancel() {
            files = [];
            document.querySelector("#uploadModal").classList.add("hidden");
            uploadManager.clear();
        }

        function getFileSize(srcLength) {
            let units = ["B", "KB", "MB", "GB"];
            var v = srcLength;
            var uIndex = 0;
            while (v > 1024 && uIndex < 3) {
                uIndex++;
                v /= 1024;
            }
            return `${Math.round(v * 100) / 100} ${units[uIndex]}`;
        }

        function formatDate(v) {
            var dt = new Date();
            if (v instanceof Date) dt = v;
            else if (v instanceof Number) {
                dt = new Date(v);
            }
            let num_year = dt.getFullYear();
            let num_month = dt.getMonth() + 1;
            let num_date = dt.getDate();
            let num_hour = dt.getHours();
            let num_min = dt.getMinutes();
            let num_sec = dt.getSeconds();

            return `${num_year}-${num_month < 10 ? "0" + num_month : num_month}-${num_date < 10 ? "0" + num_date : num_date
                } ${num_hour < 10 ? "0" + num_hour : num_hour}:${num_min < 10 ? "0" + num_min : num_min
                }:${num_sec < 10 ? "0" + num_sec : num_sec}`;

        }

        // ================= 悬停预览逻辑 =================
        let previewTimerId = null;
        let lastHoverCoords = null;
        const popover = document.getElementById('previewPopover');

        function startPreviewTimer(event, fileName, fileType) {
            // 如果是目录等不需要预览的类型可直接返回（根据实际类型值调整判断）
            if (!fileName || /dir|folder|directory/i.test(fileType)) return;
            cancelPreviewTimer();
            lastHoverCoords = { x: event.pageX, y: event.pageY };
            previewTimerId = setTimeout(() => {
                openPreviewOrShare(fileName, lastHoverCoords, true);
            }, 600);
            //600ms 后触发
        }

        function startShareTimer(event, fileName) {
            cancelPreviewTimer();
            lastHoverCoords = { x: event.pageX, y: event.pageY };
            previewTimerId = setTimeout(() => {
                openPreviewOrShare(fileName, lastHoverCoords, true, 'share');
            }, 600);
            //600ms 后触发
        }

        function cancelPreviewTimer() {
            if (previewTimerId) {
                clearTimeout(previewTimerId);
                previewTimerId = null;
            }
        }

        function hidePreviewPopover() {
            popover.classList.add('hidden');
            popover.innerHTML = '';
        }

        function positionPopover(coords) {
            if (!coords) return;
            const offset = 14;
            let left = coords.x + offset;
            let top = coords.y + offset;
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const rect = popover.getBoundingClientRect();
            if (left + rect.width > vw - 20) left = vw - rect.width - 20;
            if (top + rect.height > vh - 20) top = vh - rect.height - 20;
            popover.style.left = left + 'px';
            popover.style.top = top + 'px';
        }

        function buildPreviewList() {
            previewFileNames = Array.from(document.querySelectorAll('#tableBody button[data-filename]')).map(b => b.getAttribute('data-filename')).filter(n => !!n);
        }

        function updateNavButtons() {
            const prev = document.getElementById('prevBtn');
            const next = document.getElementById('nextBtn');
            prev.disabled = currentPreviewIndex <= 0;
            next.disabled = currentPreviewIndex >= previewFileNames.length - 1;
        }

        function openPreviewOrShare(fileName, coords = null, asPopover = false, type = 'preview') {
            if (asPopover) {
                popover.classList.remove('hidden');
                positionPopover(coords);
            }
            if (type === 'preview') {
                previewHandle(fileName, coords, asPopover)
                document.querySelector("#shareText").classList.add("hidden");
                document.querySelector("#prevBtn").classList.remove("hidden");
                document.querySelector("#nextBtn").classList.remove("hidden");
            } else {
                shareHandle(fileName, coords, asPopover)
                document.querySelector("#shareText").classList.remove("hidden");
                document.querySelector("#prevBtn").classList.add("hidden");
                document.querySelector("#nextBtn").classList.add("hidden");
            }
        }

        function previewHandle(fileName, coords, asPopover) {
            const fileExtension = fileName.split('.').pop().toLowerCase();
            if (asPopover) {
                popover.innerHTML = '<div class="text-secondary text-[11px]">加载中...</div>';
                if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                    const img = new Image();
                    img.onload = () => {
                        popover.innerHTML = '';
                        popover.appendChild(img);
                        positionPopover(coords);
                    };
                    img.onerror = () => {
                        popover.innerHTML = '<div class="text-red-500">图片加载失败</div>';
                    };
                    img.src = `./${fileName}`;
                    img.style.maxWidth = '260px';
                } else if (['txt', 'md', 'html', 'js', 'css', 'json', 'log', 'xml'].includes(fileExtension)) {
                    fetch(`./${fileName}`)
                        .then(r => r.text())
                        .then(text => {
                            const pre = document.createElement('pre');
                            if (text.length > 800) text = text.slice(0, 800) + '\n...';
                            pre.textContent = text;
                            popover.innerHTML = '';
                            popover.appendChild(pre);
                            positionPopover(coords);
                        })
                        .catch(() => {
                            popover.innerHTML = '<div class="text-red-500">预览失败</div>';
                        });
                } else {
                    popover.innerHTML = '<div class="text-secondary">不支持预览</div>';
                }
                return; // 不走模态框逻辑
            }
            // ================= 原模态框逻辑（点击） =================
            buildPreviewList();
            currentPreviewIndex = previewFileNames.indexOf(fileName);
            const modal = document.getElementById('previewModal');
            const titleEl = document.getElementById('previewTitle');
            const contentEl = document.getElementById('previewContent');
            titleEl.textContent = fileName;
            contentEl.innerHTML = '';
            let el;
            if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                el = document.createElement('img');
                el.src = `./${fileName}`;
                el.classList.add('max-w-full', 'h-auto');
                contentEl.appendChild(el);
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else if (['txt', 'md', 'html', 'js', 'css', 'json', 'log', 'xml'].includes(fileExtension)) {
                fetch(`./${fileName}`)
                    .then(r => r.text())
                    .then(text => {
                        el = document.createElement('pre');
                        el.textContent = text;
                        el.classList.add('whitespace-pre-wrap', 'p-3', 'rounded', 'max-h-[60vh]', 'overflow-auto', 'text-xs');
                        el.style.background = 'var(--panel-border)';
                        contentEl.appendChild(el);
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                    })
                    .catch(() => {
                        el = document.createElement('p');
                        el.textContent = '预览失败。';
                        el.classList.add('text-red-500');
                        contentEl.appendChild(el);
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                    });
            } else {
                el = document.createElement('p');
                el.textContent = '不支持预览此文件类型。';
                el.classList.add('text-secondary');
                contentEl.appendChild(el);
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
            updateNavButtons();
        }

        function shareHandle(fileName, coords, asPopover) {
            const shareUrl = location.href + fileName
            if (asPopover) {
                new QRCode(popover, shareUrl)
                requestAnimationFrame(() => {
                    positionPopover(coords);
                })
                return
            }
            const modal = document.getElementById('previewModal');
            const titleEl = document.getElementById('previewTitle');
            const contentEl = document.getElementById('previewContent');
            const shareTextEl = document.getElementById('shareText');
            titleEl.textContent = fileName;
            contentEl.innerHTML = '';
            shareTextEl.innerText = shareUrl;
            new QRCode(contentEl, shareUrl)
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function shareFile(e) {
            const fileName = e.currentTarget.getAttribute('data-filename');
            openPreviewOrShare(fileName, null, false, 'share');
        }

        function previewFile(e) {
            const fileName = e.currentTarget.getAttribute('data-filename');
            openPreviewOrShare(fileName);
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            currentPreviewIndex = -1;
        }

        function previewPrev() {
            if (currentPreviewIndex > 0) {
                openPreviewOrShare(previewFileNames[currentPreviewIndex - 1]);
            }
        }

        function previewNext() {
            if (currentPreviewIndex < previewFileNames.length - 1) {
                openPreviewOrShare(previewFileNames[currentPreviewIndex + 1]);
            }
        }

        // 点击遮罩空白关闭
        document.getElementById('previewModal').addEventListener('click', function (e) {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // 键盘导航
        document.addEventListener('keydown', function (e) {
            const visible = !document.getElementById('previewModal').classList.contains('hidden');
            if (!visible) return;
            if (e.key === 'ArrowLeft') {
                previewPrev();
            } else if (e.key === 'ArrowRight') {
                previewNext();
            } else if (e.key === 'Escape') {
                closePreview();
            }
        });

        // 仅文件名链接悬停触发
        const tableBody = document.getElementById('tableBody');
        tableBody.addEventListener('mouseover', e => {
            let link = e.target.closest('a[data-hover-preview]');
            if (link) {
                startPreviewTimer(e, link.getAttribute('data-filename'), link.getAttribute('data-filetype'));
                return
            }
            link = e.target.closest('button[data-hover-share]');
            if (link) {
                startShareTimer(e, link.getAttribute('data-filename'));
            }
        });
        tableBody.addEventListener('mouseout', e => {
            const link = e.target.closest('a[data-hover-preview]') || e.target.closest('button[data-hover-share]');
            if (link) {
                cancelPreviewTimer();
                hidePreviewPopover();
            }
        });
        tableBody.addEventListener('mousemove', e => {
            if (!popover.classList.contains('hidden')) {
                lastHoverCoords = { x: e.pageX, y: e.pageY };
                positionPopover(lastHoverCoords);
            }
        });
    </script>
</body>
</html>