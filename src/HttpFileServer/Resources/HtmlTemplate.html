<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理系统</title>
    <script>{{tailwindcss}}</script>
    <style>
        .table-container {
            overflow-y: auto;
        }

        .table-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .file {
            background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAABnRSTlMAAAAAAABupgeRAAABHUlEQVR42o2RMW7DIBiF3498iHRJD5JKHurL+CRVBp+i2T16tTynF2gO0KSb5ZrBBl4HHDBuK/WXACH4eO9/CAAAbdvijzLGNE1TVZXfZuHg6XCAQESAZXbOKaXO57eiKG6ft9PrKQIkCQqFoIiQFBGlFIB5nvM8t9aOX2Nd18oDzjnPgCDpn/BH4zh2XZdlWVmWiUK4IgCBoFMUz9eP6zRN75cLgEQhcmTQIbl72O0f9865qLAAsURAAgKBJKEtgLXWvyjLuFsThCSstb8rBCaAQhDYWgIZ7myM+TUBjDHrHlZcbMYYk34cN0YSLcgS+wL0fe9TXDMbY33fR2AYBvyQ8L0Gk8MwREBrTfKe4TpTzwhArXWi8HI84h/1DfwI5mhxJamFAAAAAElFTkSuQmCC ") left top no-repeat;
        }

        .dir {
            background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYUR5ccllPAAAAd5JREFUeNqMU79rFUEQ/vbuodFEEkzAImBpkUabFP4ldpaJhZXYm/RiZWsv/hkWFglBUyTIgyAIIfgIRjHv3r39MePM7N3LcbxAFvZ2b2bn22/mm3XMjF+HL3YW7q28YSIw8mBKoBihhhgCsoORot9d3/ywg3YowMXwNde/PzGnk2vn6PitrT+/PGeNaecg4+qNY3D43vy16A5wDDd4Aqg/ngmrjl/GoN0U5V1QquHQG3q+TPDVhVwyBffcmQGJmSVfyZk7R3SngI4JKfwDJ2+05zIg8gbiereTZRHhJ5KCMOwDFLjhoBTn2g0ghagfKeIYJDPFyibJVBtTREwq60SpYvh5++PpwatHsxSm9QRLSQpEVSd7/TYJUb49TX7gztpjjEffnoVw66+Ytovs14Yp7HaKmUXeX9rKUoMoLNW3srqI5fWn8JejrVkK0QcrkFLOgS39yoKUQe292WJ1guUHG8K2o8K00oO1BTvXoW4yasclUTgZYJY9aFNfAThX5CZRmczAV52oAPoupHhWRIUUAOoyUIlYVaAa/VbLbyiZUiyFbjQFNwiZQSGl4IDy9sO5Wrty0QLKhdZPxmgGcDo8ejn+c/6eiK9poz15Kw7Dr/vN/z6W7q++091/AQYA5mZ8GYJ9K0AAAAAASUVORK5CYII= ") left top no-repeat;
        }

        .up {
            background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYUR5ccllPAAAAmlJREFUeNpsU0toU0EUPfPysx/tTxuDH9SCWhUDooIbd7oRUUTMouqi2iIoCO6lceHWhegy4EJFinWjrlQUpVm0IIoFpVDEIthm0dpikpf3ZuZ6Z94nrXhhMjM3c8895977BBHB2PznK8WPtDgyWH5q77cPH8PpdXuhpQT4ifR9u5sfJb1bmw6VivahATDrxcRZ2njfoaMv+2j7mLDn93MPiNRMvGbL18L9IpF8h9/TN+EYkMffSiOXJ5+hkD+PdqcLpICWHOHc2CC+LEyA/K+cKQMnlQHJX8wqYG3MAJy88Wa4OLDvEqAEOpJd0LxHIMdHBziowSwVlF8D6QaicK01krw/JynwcKoEwZczewroTvZirlKJs5CqQ5CG8pb57FnJUA0LYCXMX5fibd+p8LWDDemcPZbzQyjvH+Ki1TlIciElA7ghwLKV4kRZstt2sANWRjYTAGzuP2hXZFpJ/GsxgGJ0ox1aoFWsDXyyxqCs26+ydmagFN/rRjymJ1898bzGzmQE0HCZpmk5A0RFIv8Pn0WYPsiu6t/Rsj6PauVTwffTSzGAGZhUG2F06hEc9ibS7OPMNp6ErYFlKavo7MkhmTqCxZ/jwzGA9Hx82H2BZSw1NTN9Gx8ycHkajU/7M+jInsDC7DiaEmo1bNl1AMr9ASFgqVu9MCTIzoGUimXVAnnaN0PdBBDCCYbEtMk6wkpQwIG0sn0PQIUF4GsTwLSIFKNqF6DVrQq+IWVrQDxAYQC/1SsYOI4pOxKZrfifiUSbDUisif7XlpGIPufXd/uvdvZm760M0no1FZcnrzUdjw7au3vu/BVgAFLXeuTxhTXVAAAAAElFTkSuQmCC ") left top no-repeat;
        }

        /* 悬停浮层 */
        #previewPopover {
            position: absolute;
            top: 0;
            left: 0;
            background: #fff;
            border: 1px solid #d1d5db;
            /* 灰色边框 */
            border-radius: 4px;
            padding: 6px 8px;
            /* 紧凑内边距 */
            font-size: 12px;
            /* 更小字号 */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            max-height: 240px;
            overflow: auto;
            z-index: 1000;
            line-height: 1.35;
        }

        #previewPopover.hidden {
            display: none;
        }

        #previewPopover img {
            max-width: 260px;
            height: auto;
            display: block;
        }

        #previewPopover pre {
            font-size: 11px;
            margin: 0;
            white-space: pre-wrap;
        }

        /* 模态框保留居中风格：去除初始 display:none，使用 .hidden 控制 */
        #previewModal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1050;
            display: flex;
        }

        #previewModal.hidden {
            display: none;
        }

        #previewModalInner {
            background: #fff;
            border-radius: 8px;
            max-width: 60%;
            width: 100%;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
        }

        #previewModal.show {
            display: flex;
            /* 之前是 block，这里改为 flex 以支持子元素的过渡动画 */
        }

        #previewModal .closeBtn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4B5563;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #previewModal .closeBtn:hover {
            background: #374151;
        }

        #previewModal .navBtn {
            background: #f3f4f6;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #previewModal .navBtn:hover {
            background: #e5e7eb;
        }

        #previewModal .title {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
        }

        #previewModal .content {
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #previewModal img {
            max-width: 100%;
            max-height: calc(80vh - 200px);
            /* 图片最大高度，不超过视口高度减去标题和按钮的空间 */
        }

        #previewModal pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: calc(80vh - 200px);
            overflow-y: auto;
            width: 100%;
        }

        #previewModal.show #previewContent {
            opacity: 0;
            transform: translateY(10px);
        }

        #previewModal.show #previewContent.img {
            animation: fadeInUp 0.5s forwards;
        }

        #previewModal.show #previewContent.txt {
            animation: fadeInUp 0.7s forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <title id="title">{{title}}</title>
</head>

<body class="bg-gray-50 min-h-screen">
    <!--头部导航 -->
    <header class="h-16 bg-white shadow-sm border-b">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">{{header}}</h1>
                </div>
            </div>
    </header>

    <div class="h-[calc(100vh-128px)] w-full px-4 sm:px-6 lg:px-8 py-8">
        <!-- 文件操作区域 -->
        <div class="h-full bg-white rounded-lg shadow-sm border box-border">
            <!--视图切换区域 -->
            <div id="fileContainer" class="h-full p-6 relative flex flex-col">
                <!-- 表格视图 -->
                <div id="tableViewContent" class="table-container flex-auto h-full mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">大小
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">修改日期
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            {{tableRows}}
                        </tbody>
                    </table>
                </div>
                <!-- 概览信息 -->
                <div class="flex-none">
                    <span class="text-sm text-gray-600">总计: {{itemcount}} 个项目</span>
                </div>
            </div>
        </div>
    </div>
    <!-- 底部导航 -->
    <footer class="flex justify-center pb-8">
        <div class="flex items-center space-x-2 text-gray-400">{{footer}}</div>
    </footer>

    <!-- 悬停预览浮层 -->
    <div id="previewPopover" class="hidden"></div>

    <!-- 修改后的预览模态框 -->
    <div id="previewModal" class="hidden">
        <div id="previewModalInner" class="rounded-xl">
            <div class="px-4 py-2 border-b flex items-center space-x-2">
                <button id="prevBtn" class="px-2 py-1 text-xs border rounded disabled:opacity-30" onclick="previewPrev()">
                    ◀
                </button>
                <button id="nextBtn" class="px-2 py-1 text-xs border rounded disabled:opacity-30" onclick="previewNext()">
                    ▶
                </button>
                <h3 id="previewTitle" class="text-sm font-semibold text-gray-900 flex-1 truncate">文件预览</h3>
                <button id="closePreview" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="closePreview()">关闭</button>
            </div>
            <div class="p-4">
                <div id="previewContent" class="flex justify-center"></div>
            </div>
        </div>
    </div>
    {{uploadSection}}
    <script>
        let files = [];
        const mainBody = document.querySelector("body");
        const uploadManager = new UploadManager();
        //预览文件列表与当前索引
        let previewFileNames = [];
        let currentPreviewIndex = -1;

        mainBody.addEventListener("dragover", e => e.preventDefault());
        mainBody.addEventListener("dragleave", e => e.preventDefault());
        mainBody.addEventListener("drop", dropHandle);

        async function dropHandle(event) {
            event.preventDefault();
            const promises = [];

            for (const item of event.dataTransfer.items) {
                const entry = item.webkitGetAsEntry();
                console.log("[ entry ] >", entry);
                promises.push(readFiles(entry));
            }

            const resultFilesArrays = await Promise.all(promises);
            files = resultFilesArrays.flat().reverse();

            let dataStr = files.map(file => `
                                                                  <tr class="hover:bg-gray-50 transition-colors">
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.fullPath}</td>
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getFileSize(file.size)}</td>
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(file.lastModifiedDate)}</td>
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 uploadStatus">待上传</td>
                                                                  </tr>
                                                              `).join('');

            document.querySelector("#fileInfo").innerHTML = dataStr;
            const overview = document.getElementById('overview')
            overview.innerText = `文件总数：${files.length}`

            document.querySelector("#confirm").classList.add("hidden");
            document.querySelector("#cancel").classList.remove("hidden");
            document.querySelector("#uploader").classList.remove("hidden");
            document.querySelector("#uploadModal").classList.remove("hidden");
        }
        //读取文件/文件夹
        async function readFiles(item) {
            if (item.isDirectory) {
                // 是一个文件夹
                const directoryReader = item.createReader();
                // readEntries是一个异步方法
                const entries = await new Promise((resolve, reject) => {
                    directoryReader.readEntries(resolve, reject);
                });

                let files = [];
                for (const entry of entries) {
                    const resultFiles = await readFiles(entry);
                    files = files.concat(resultFiles);
                }
                return files;
            } else {
                // 是一个文件
                const file = await new Promise((resolve, reject) => {
                    item.file(resolve, reject);
                });
                file.fullPath = item.fullPath;
                return [file];
            }
        }

        async function sendFiles() {
            if (!files.length) return;
            document.querySelector("#confirm").classList.add("hidden");
            document.querySelector("#cancel").classList.remove("hidden");
            document.querySelector("#uploader").classList.add("hidden");
            const statusBoxs = Array.from(document.querySelectorAll(".uploadStatus"));
            const fileItems = statusBoxs.map((e, i) => {
                return {
                    file: files[i],
                    progressEle: e,
                };
            });

            await uploadManager.addFiles(fileItems);
            uploadManager.queue.getStatus();
            uploadManager.queue.startTask();
            uploadManager.onComplete = (summary) => {
                files = [];
                document.querySelector("#confirm").classList.remove("hidden");
                document.querySelector("#cancel").classList.add("hidden");
                document.querySelector("#uploader").classList.add("hidden");
            };
        }

        function cancel() {
            files = [];
            document.querySelector("#uploadModal").classList.add("hidden");
            uploadManager.clear();
        }

        function getFileSize(srcLength) {
            let units = ["B", "KB", "MB", "GB"];
            var v = srcLength;
            var uIndex = 0;
            while (v > 1024 && uIndex < 3) {
                uIndex++;
                v /= 1024;
            }
            return `${Math.round(v * 100) / 100} ${units[uIndex]}`;
        }

        function formatDate(v) {
            var dt = new Date();
            if (v instanceof Date) dt = v;
            else if (v instanceof Number) {
                dt = new Date(v);
            }
            let num_year = dt.getFullYear();
            let num_month = dt.getMonth() + 1;
            let num_date = dt.getDate();
            let num_hour = dt.getHours();
            let num_min = dt.getMinutes();
            let num_sec = dt.getSeconds();

            return `${num_year}-${num_month < 10 ? "0" + num_month : num_month}-${num_date < 10 ? "0" + num_date : num_date
                } ${num_hour < 10 ? "0" + num_hour : num_hour}:${num_min < 10 ? "0" + num_min : num_min
                }:${num_sec < 10 ? "0" + num_sec : num_sec}`;


        }

        // ================= 悬停预览逻辑 =================
        let previewTimerId = null;
        let lastHoverCoords = null;
        const popover = document.getElementById('previewPopover');

        function startPreviewTimer(event, fileName, fileType) {
            // 如果是目录等不需要预览的类型可直接返回（根据实际类型值调整判断）
            if (!fileName || /dir|folder|directory/i.test(fileType)) return;
            cancelPreviewTimer();
            lastHoverCoords = { x: event.pageX, y: event.pageY };
            previewTimerId = setTimeout(() => {
                openPreviewByName(fileName, lastHoverCoords, true);
            }, 600);
            //600ms 后触发
        }

        function cancelPreviewTimer() {
            if (previewTimerId) {
                clearTimeout(previewTimerId);
                previewTimerId = null;
            }
        }

        function hidePreviewPopover() {
            popover.classList.add('hidden');
            popover.innerHTML = '';
        }

        function positionPopover(coords) {
            if (!coords) return;
            const offset = 14;
            let left = coords.x + offset;
            let top = coords.y + offset;
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const rect = popover.getBoundingClientRect();
            if (left + rect.width > vw - 20) left = vw - rect.width - 20;
            if (top + rect.height > vh - 20) top = vh - rect.height - 20;
            popover.style.left = left + 'px';
            popover.style.top = top + 'px';
        }

        function buildPreviewList() {
            previewFileNames = Array.from(document.querySelectorAll('#tableBody button[data-filename]')).map(b => b.getAttribute('data-filename')).filter(Boolean);
        }

        function updateNavButtons() {
            const prev = document.getElementById('prevBtn');
            const next = document.getElementById('nextBtn');
            prev.disabled = currentPreviewIndex <= 0;
            next.disabled = currentPreviewIndex >= previewFileNames.length - 1;
        }

        function openPreviewByName(fileName, coords = null, asPopover = false) {
            if (asPopover) {
                popover.innerHTML = '<div class="text-gray-400 text-[11px]">加载中...</div>';
                popover.classList.remove('hidden');
                positionPopover(coords);
            }
            const fileExtension = fileName.split('.').pop().toLowerCase();
            if (asPopover) {
                if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                    const img = new Image();
                    img.onload = () => {
                        popover.innerHTML = '';
                        popover.appendChild(img);
                        positionPopover(coords);
                    };
                    img.onerror = () => {
                        popover.innerHTML = '<div class="text-red-500">图片加载失败</div>';
                    };
                    img.src = `./${fileName}`;
                    img.style.maxWidth = '260px';
                } else if (['txt', 'md', 'html', 'js', 'css', 'json', 'log', 'xml'].includes(fileExtension)) {
                    fetch(`./${fileName}`)
                        .then(r => r.text())
                        .then(text => {
                            const pre = document.createElement('pre');
                            if (text.length > 800) text = text.slice(0, 800) + '\n...';
                            pre.textContent = text;
                            popover.innerHTML = '';
                            popover.appendChild(pre);
                            positionPopover(coords);
                        })
                        .catch(() => {
                            popover.innerHTML = '<div class="text-red-500">预览失败</div>';
                        });
                } else {
                    popover.innerHTML = '<div class="text-gray-600">不支持预览</div>';
                }
                return; // 不走模态框逻辑
            }
            // ================= 原模态框逻辑（点击） =================
            buildPreviewList();
            currentPreviewIndex = previewFileNames.indexOf(fileName);
            const modal = document.getElementById('previewModal');
            const titleEl = document.getElementById('previewTitle');
            const contentEl = document.getElementById('previewContent');
            titleEl.textContent = fileName;
            contentEl.innerHTML = '';
            let el;
            if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                el = document.createElement('img');
                el.src = `./${fileName}`;
                el.classList.add('max-w-full', 'h-auto');
                contentEl.appendChild(el);
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else if (['txt', 'md', 'html', 'js', 'css', 'json', 'log', 'xml'].includes(fileExtension)) {
                fetch(`./${fileName}`)
                    .then(r => r.text())
                    .then(text => {
                        el = document.createElement('pre');
                        el.textContent = text;
                        el.classList.add('whitespace-pre-wrap', 'bg-gray-100', 'p-3', 'rounded', 'max-h-[60vh]', 'overflow-auto', 'text-xs');
                        contentEl.appendChild(el);
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                    })
                    .catch(() => {
                        el = document.createElement('p');
                        el.textContent = '预览失败。';
                        el.classList.add('text-red-500');
                        contentEl.appendChild(el);
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                    });
            } else {
                el = document.createElement('p');
                el.textContent = '不支持预览此文件类型。';
                el.classList.add('text-gray-600');
                contentEl.appendChild(el);
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
            updateNavButtons();
        }

        function previewFile(e) {
            const fileName = e.currentTarget.getAttribute('data-filename');
            openPreviewByName(fileName);
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            currentPreviewIndex = -1;
        }

        function previewPrev() {
            if (currentPreviewIndex > 0) {
                openPreviewByName(previewFileNames[currentPreviewIndex - 1]);
            }
        }

        function previewNext() {
            if (currentPreviewIndex < previewFileNames.length - 1) {
                openPreviewByName(previewFileNames[currentPreviewIndex + 1]);
            }
        }

        // 点击遮罩空白关闭
        document.getElementById('previewModal').addEventListener('click', function (e) {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // 键盘导航
        document.addEventListener('keydown', function (e) {
            const visible = !document.getElementById('previewModal').classList.contains('hidden');
            if (!visible) return;
            if (e.key === 'ArrowLeft') {
                previewPrev();
            } else if (e.key === 'ArrowRight') {
                previewNext();
            } else if (e.key === 'Escape') {
                closePreview();
            }
        });

        // 仅文件名链接悬停触发
        const tableBody = document.getElementById('tableBody');
        tableBody.addEventListener('mouseover', e => {
            const link = e.target.closest('a[data-hover-preview]');
            if (!link) return;
            startPreviewTimer(e, link.getAttribute('data-filename'), link.getAttribute('data-filetype'));
        });
        tableBody.addEventListener('mouseout', e => {
            const link = e.target.closest('a[data-hover-preview]');
            if (link) {
                cancelPreviewTimer();
                hidePreviewPopover();
            }
        });
        tableBody.addEventListener('mousemove', e => {
            if (!popover.classList.contains('hidden')) {
                lastHoverCoords = { x: e.pageX, y: e.pageY };
                positionPopover(lastHoverCoords);
            }
        });
    </script>
</body>

</html>