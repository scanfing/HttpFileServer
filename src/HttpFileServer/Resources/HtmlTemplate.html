<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HttpFileServer</title>
    <script src="/qrcode.min.js?type=resource"></script>
    <script src="/tailwindcss.3.4.17.js?type=resource"></script>
    <link rel="stylesheet" href="/appstyle.css?type=resource" />
    <title id="title">{{title}}</title>
    <style>
        /* QR button style */
        .qr-btn {
            /* make the QR icon look like the text action links on the left */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: auto;
            height: 1em;
            /* match text line height */
            line-height: 1;
            vertical-align: middle;
            /* align with surrounding text */
            border: none;
            /* remove boxed border */
            border-radius: 4px;
            background: transparent;
            color: inherit;
            /* inherit link/text color */
            transition: color .12s, transform .06s;
            box-shadow: none;
            cursor: pointer;
            padding: 0 6px;
            /* small horizontal padding to match spacing */
            font-size: 14px;
        }

            .qr-btn:hover {
                text-decoration: underline;
                /* behave like a link */
                transform: translateY(-1px);
            }

            .qr-btn:focus {
                outline: 2px solid rgba(59,130,246,0.3);
                outline-offset: 2px;
                border-radius: 6px;
            }

            .qr-btn svg {
                width: 18px;
                height: 18px;
                display: block;
                /* avoid inline spacing quirks */
                fill: currentColor;
                /* small vertical nudge to better match text baseline */
                transform: translateY(1px);
            }

        /* Center action buttons in the last column */
        #tableBody td:last-child {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* spacing between actions */
        }

        /* popovers and modals */
        #qrPopover, #previewPopover {
            position: absolute;
            z-index: 70;
            padding: 10px;
            border-radius: 10px;
            background: var(--panel-bg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.04);
            transition: opacity .12s, transform .12s;
            opacity: 0;
            transform: scale(.98);
            pointer-events: none;
        }

            #qrPopover:not(.hidden), #previewPopover:not(.hidden) {
                opacity: 1;
                transform: scale(1);
                pointer-events: auto
            }

        /* modal overlay */
        #qrModal, #previewModal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.45);
            z-index: 80;
            padding: 20px;
        }

        #qrModalInner, #previewModalInner {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 0;
            max-width: 92%;
            width: 480px;
            box-shadow: 0 18px 50px rgba(2,6,23,0.6);
            border: 1px solid var(--panel-border);
            overflow: hidden;
        }

        #qrModalContent {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #qrModalText {
            padding: 0 20px 20px
        }

        /* responsive */
        @media (max-width:480px) {
            #qrModalInner {
                width: 92%
            }

            #qrModalContent div {
                width: 240px;
                height: 240px
            }
        }
    </style>
</head>

<body class="min-h-screen">
    <!--头部导航 -->
    <header class="h-16 shadow-sm border-b">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-primary">{{header}}</h1>
                </div>
            </div>
        </div>
    </header>

    <div class="h-[calc(100vh-128px)] w-full px-4 sm:px-6 lg:px-8 py-8">
        <!-- 文件操作区域 -->
        <div class="h-full theme-panel rounded-lg shadow-sm">
            <!--视图切换区域 -->
            <div id="fileContainer" class="h-full p-6 relative flex flex-col">
                <!-- 表格视图 -->
                <div id="tableViewContent" class="table-container flex-auto h-full mb-4">
                    <table class="min-w-full divide-y" style="border-color:var(--panel-border)">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">大小</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">修改日期</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">类型</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y" style="border-color:var(--panel-border)">
                            {{tableRows}}
                        </tbody>
                    </table>
                </div>
                <!-- 概览信息 -->
                <div class="flex-none">
                    <span class="text-sm text-secondary">总计: {{itemcount}} 个项目</span>
                </div>
            </div>
        </div>
    </div>
    <!-- 底部导航 -->
    <footer class="flex justify-center pb-8">
        <div class="flex items-center space-x-2 text-secondary">{{footer}}</div>
    </footer>

    <!-- 悬停预览浮层 -->
    <div id="previewPopover" class="hidden"></div>
    <!-- QR 悬停浮层 -->
    <div id="qrPopover" class="hidden"></div>

    <!-- 修改后的预览模态框 -->
    <div id="previewModal" class="hidden">
        <div id="previewModalInner" class="rounded-xl">
            <div class="px-4 py-2 border-b flex items-center space-x-2">
                <button id="prevBtn" class="px-2 py-1 text-xs border rounded disabled:opacity-30" onclick="previewPrev()">
                    ◀
                </button>
                <button id="nextBtn" class="px-2 py-1 text-xs border rounded disabled:opacity-30" onclick="previewNext()">
                    ▶
                </button>
                <h3 id="previewTitle" class="text-sm font-semibold text-gray-900 flex-1 truncate">文件预览</h3>
                <button id="closePreview" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="closePreview()">关闭</button>
            </div>
            <div class="p-4">
                <div id="previewContent" class="flex justify-center"></div>
            </div>
        </div>
    </div>

    <!-- QR 大模态框 -->
    <div id="qrModal" class="hidden">
        <div id="qrModalInner" class="rounded-xl" style="max-width:420px; width:90%;">
            <div class="px-4 py-2 border-b flex items-center space-x-2">
                <h3 id="qrModalTitle" class="text-sm font-semibold text-gray-900 flex-1 truncate">二维码</h3>
                <button id="closeQrModal" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="closeQrModal()">关闭</button>
            </div>
            <div id="qrModalContent" class="p-4 flex flex-col items-center">
            </div>
            <div id="qrModalText" class="mt-3 text-sm text-secondary break-words text-center" style="padding:0 20px 20px"></div>
        </div>
    </div>

    <!--主题切换按钮（固定右下角） -->
    <button id="themeToggle" class="theme-toggle-btn" type="button">切换主题</button>
    {{uploadSection}}
    <script>
        //主题初始化与切换
        const root = document.documentElement;
        const savedTheme = localStorage.getItem('webTheme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(mode) {
            root.setAttribute('data-theme', mode);
        }
        applyTheme(savedTheme ? savedTheme : (prefersDark.matches ? 'dark' : 'light'));
        prefersDark.addEventListener('change', e => {
            if (!localStorage.getItem('webTheme')) applyTheme(e.matches ? 'dark' : 'light');
        });
        document.getElementById('themeToggle').addEventListener('click', () => {
            const cur = root.getAttribute('data-theme');
            const next = cur === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem('webTheme', next);
        });

        // ===== 原有脚本保持 =====
        let files = [];
        const mainBody = document.querySelector('body');
        const uploadManager = new UploadManager();
        let previewFileNames = [];
        let currentPreviewIndex = -1;

        mainBody.addEventListener("dragover", e => e.preventDefault());
        mainBody.addEventListener("dragleave", e => e.preventDefault());
        mainBody.addEventListener("drop", dropHandle);

        async function dropHandle(event) {
            event.preventDefault();
            const promises = [];

            for (const item of event.dataTransfer.items) {
                const entry = item.webkitGetAsEntry();
                promises.push(readFiles(entry));
            }

            const resultFilesArrays = await Promise.all(promises);
            files = resultFilesArrays.flat().reverse();

            let dataStr = files.map(file => `
                                                 <tr class='row-hover transition-colors'>
                                                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${file.fullPath}</td>
                                                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${getFileSize(file.size)}</td>
                                                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${formatDate(file.lastModifiedDate)}</td>
                                                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${file.type}</td>
                                                 <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary uploadStatus'>待上传</td>
                                                 </tr>
                                                 `).join('');

            document.querySelector("#fileInfo").innerHTML = dataStr;
            const overview = document.getElementById('overview')
            overview.innerText = `文件总数：${files.length}`

            document.querySelector("#confirm").classList.add("hidden");
            document.querySelector("#cancel").classList.remove("hidden");
            document.querySelector("#uploader").classList.remove("hidden");
            document.querySelector("#uploadModal").classList.remove("hidden");
        }
        //读取文件/文件夹
        async function readFiles(item) {
            if (item.isDirectory) {
                // 是一个文件夹
                const directoryReader = item.createReader();
                // readEntries是一个异步方法
                const entries = await new Promise((resolve, reject) => {
                    directoryReader.readEntries(resolve, reject);
                });

                let files = [];
                for (const entry of entries) {
                    const resultFiles = await readFiles(entry);
                    files = files.concat(resultFiles);
                }
                return files;
            } else {
                // 是一个文件
                const file = await new Promise((resolve, reject) => {
                    item.file(resolve, reject);
                });
                file.fullPath = item.fullPath;
                return [file];
            }
        }

        async function sendFiles() {
            if (!files.length) return;
            document.querySelector("#confirm").classList.add("hidden");
            document.querySelector("#cancel").classList.remove("hidden");
            document.querySelector("#uploader").classList.add("hidden");
            const statusBoxs = Array.from(document.querySelectorAll(".uploadStatus"));
            const fileItems = statusBoxs.map((e, i) => {
                return {
                    file: files[i],
                    progressEle: e,
                };
            });

            await uploadManager.addFiles(fileItems);
            uploadManager.queue.getStatus();
            uploadManager.queue.startTask();
            uploadManager.onComplete = (summary) => {
                files = [];
                document.querySelector("#confirm").classList.remove("hidden");
                document.querySelector("#cancel").classList.add("hidden");
                document.querySelector("#uploader").classList.add("hidden");
            };
        }

        function cancel() {
            files = [];
            document.querySelector("#uploadModal").classList.add("hidden");
            uploadManager.clear();
        }

        function getFileSize(srcLength) {
            let units = ["B", "KB", "MB", "GB"];
            var v = srcLength;
            var uIndex = 0;
            while (v > 1024 && uIndex < 3) {
                uIndex++;
                v /= 1024;
            }
            return `${Math.round(v * 100) / 100} ${units[uIndex]}`;
        }

        function formatDate(v) {
            var dt = new Date();
            if (v instanceof Date) dt = v;
            else if (v instanceof Number) {
                dt = new Date(v);
            }
            let num_year = dt.getFullYear();
            let num_month = dt.getMonth() + 1;
            let num_date = dt.getDate();
            let num_hour = dt.getHours();
            let num_min = dt.getMinutes();
            let num_sec = dt.getSeconds();

            return `${num_year}-${num_month < 10 ? "0" + num_month : num_month}-${num_date < 10 ? "0" + num_date : num_date
                } ${num_hour < 10 ? "0" + num_hour : num_hour}:${num_min < 10 ? "0" + num_min : num_min
                }:${num_sec < 10 ? "0" + num_sec : num_sec}`;

        }

        // ================= 悬停预览逻辑 =================
        let previewTimerId = null;
        let lastHoverCoords = null;
        const popover = document.getElementById('previewPopover');

        function startPreviewTimer(event, fileName, fileType) {
            // 如果是目录等不需要预览的类型可直接返回（根据实际类型值调整判断）
            if (!fileName || /dir|folder|directory/i.test(fileType)) return;
            cancelPreviewTimer();
            lastHoverCoords = { x: event.pageX, y: event.pageY };
            previewTimerId = setTimeout(() => {
                openPreviewByName(fileName, lastHoverCoords, true);
            }, 600);
            //600ms 后触发
        }

        function cancelPreviewTimer() {
            if (previewTimerId) {
                clearTimeout(previewTimerId);
                previewTimerId = null;
            }
        }

        function hidePreviewPopover() {
            popover.classList.add('hidden');
            popover.innerHTML = '';
        }

        function positionPopover(coords) {
            if (!coords) return;
            const offset = 14;
            let left = coords.x + offset;
            let top = coords.y + offset;
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const rect = popover.getBoundingClientRect();
            if (left + rect.width > vw - 20) left = vw - rect.width - 20;
            if (top + rect.height > vh - 20) top = vh - rect.height - 20;
            popover.style.left = left + 'px';
            popover.style.top = top + 'px';
        }

        function buildPreviewList() {
            previewFileNames = Array.from(document.querySelectorAll('#tableBody button[data-filename]')).map(b => b.getAttribute('data-filename')).filter(Boolean);
        }

        function updateNavButtons() {
            const prev = document.getElementById('prevBtn');
            const next = document.getElementById('nextBtn');
            prev.disabled = currentPreviewIndex <= 0;
            next.disabled = currentPreviewIndex >= previewFileNames.length - 1;
        }

        function openPreviewByName(fileName, coords = null, asPopover = false) {
            if (asPopover) {
                popover.innerHTML = '<div class="text-secondary text-[11px]">加载中...</div>';
                popover.classList.remove('hidden');
                positionPopover(coords);
            }
            const fileExtension = fileName.split('.').pop().toLowerCase();
            if (asPopover) {
                if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                    const img = new Image();
                    img.onload = () => {
                        popover.innerHTML = '';
                        popover.appendChild(img);
                        positionPopover(coords);
                    };
                    img.onerror = () => {
                        popover.innerHTML = '<div class="text-red-500">图片加载失败</div>';
                    };
                    img.src = `./${fileName}`;
                    img.style.maxWidth = '260px';
                } else if (['txt', 'md', 'html', 'js', 'css', 'json', 'log', 'xml'].includes(fileExtension)) {
                    fetch(`./${fileName}`)
                        .then(r => r.text())
                        .then(text => {
                            const pre = document.createElement('pre');
                            if (text.length > 800) text = text.slice(0, 800) + '\n...';
                            pre.textContent = text;
                            popover.innerHTML = '';
                            popover.appendChild(pre);
                            positionPopover(coords);
                        })
                        .catch(() => {
                            popover.innerHTML = '<div class="text-red-500">预览失败</div>';
                        });
                } else {
                    popover.innerHTML = '<div class="text-secondary">不支持预览</div>';
                }
                return; // 不走模态框逻辑
            }
            // ================= 原模态框逻辑（点击） =================
            buildPreviewList();
            currentPreviewIndex = previewFileNames.indexOf(fileName);
            const modal = document.getElementById('previewModal');
            const titleEl = document.getElementById('previewTitle');
            const contentEl = document.getElementById('previewContent');
            titleEl.textContent = fileName;
            contentEl.innerHTML = '';
            let el;
            if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                el = document.createElement('img');
                el.src = `./${fileName}`;
                el.classList.add('max-w-full', 'h-auto');
                contentEl.appendChild(el);
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else if (['txt', 'md', 'html', 'js', 'css', 'json', 'log', 'xml'].includes(fileExtension)) {
                fetch(`./${fileName}`)
                    .then(r => r.text())
                    .then(text => {
                        el = document.createElement('pre');
                        el.textContent = text;
                        el.classList.add('whitespace-pre-wrap', 'p-3', 'rounded', 'max-h-[60vh]', 'overflow-auto', 'text-xs');
                        el.style.background = 'var(--panel-border)';
                        contentEl.appendChild(el);
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                    })
                    .catch(() => {
                        el = document.createElement('p');
                        el.textContent = '预览失败。';
                        el.classList.add('text-red-500');
                        contentEl.appendChild(el);
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                    });
            } else {
                el = document.createElement('p');
                el.textContent = '不支持预览此文件类型。';
                el.classList.add('text-secondary');
                contentEl.appendChild(el);
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
            updateNavButtons();
        }

        function previewFile(e) {
            const fileName = e.currentTarget.getAttribute('data-filename');
            openPreviewByName(fileName);
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            currentPreviewIndex = -1;
        }

        function previewPrev() {
            if (currentPreviewIndex > 0) {
                openPreviewByName(previewFileNames[currentPreviewIndex - 1]);
            }
        }

        function previewNext() {
            if (currentPreviewIndex < previewFileNames.length - 1) {
                openPreviewByName(previewFileNames[currentPreviewIndex + 1]);
            }
        }

        // 点击遮罩空白关闭
        document.getElementById('previewModal').addEventListener('click', function (e) {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // 键盘导航
        document.addEventListener('keydown', function (e) {
            const visible = !document.getElementById('previewModal').classList.contains('hidden');
            if (!visible) return;
            if (e.key === 'ArrowLeft') {
                previewPrev();
            } else if (e.key === 'ArrowRight') {
                previewNext();
            } else if (e.key === 'Escape') {
                closePreview();
            }
        });

        // 仅文件名链接悬停触发
        const tableBody = document.getElementById('tableBody');
        tableBody.addEventListener('mouseover', e => {
            const link = e.target.closest('a[data-hover-preview]');
            if (!link) return;
            startPreviewTimer(e, link.getAttribute('data-filename'), link.getAttribute('data-filetype'));
        });
        tableBody.addEventListener('mouseout', e => {
            const link = e.target.closest('a[data-hover-preview]');
            if (link) {
                cancelPreviewTimer();
                hidePreviewPopover();
            }
        });
        tableBody.addEventListener('mousemove', e => {
            if (!popover.classList.contains('hidden')) {
                lastHoverCoords = { x: e.pageX, y: e.pageY };
                positionPopover(lastHoverCoords);
            }
        });

        // ================= QR 逻辑 =================
        const qrPopover = document.getElementById('qrPopover');
        let qrTimerId = null;
        let lastQrCoords = null;
        let lastQrTarget = null;

        // 构建完整外部访问 URL，如: http://host:port/path/to/file
        function buildAbsoluteUrl(file) {
            if (!file) return '';
            // 去掉可能的前导斜杠，保留路径分隔符
            const path = String(file).replace(/^\/+/, '');
            return `${window.location.protocol}//${window.location.host}/${encodeURI(path)}`;
        }

        function startQrTimer(event, text, fileName) {
            if (!text) return;
            cancelQrTimer();
            // remember both mouse coords and the closest qr button element (if any)
            lastQrCoords = { x: event.pageX, y: event.pageY };
            lastQrTarget = event.target && event.target.closest ? event.target.closest('button[data-qrcode]') : null;
            qrTimerId = setTimeout(() => {
                openQrPopover(text, lastQrCoords);
            }, 400);
        }
        function cancelQrTimer() {
            if (qrTimerId) {
                clearTimeout(qrTimerId);
                qrTimerId = null;
            }
            lastQrTarget = null;
        }

        function openQrPopover(text, coords) {
            qrPopover.innerHTML = '<div class="text-secondary text-[11px]">加载中...</div>';
            qrPopover.classList.remove('hidden');
            positionQrPopover(coords);
            // 生成二维码
            setTimeout(() => {
                qrPopover.innerHTML = '';
                const qrWrap = document.createElement('div');
                qrWrap.style.width = '160px';
                qrWrap.style.height = '160px';
                qrPopover.appendChild(qrWrap);
                try {
                    // davidshimjs qrcode lib
                    new QRCode(qrWrap, { text: text, width: 160, height: 160 });
                } catch (e) {
                    qrWrap.textContent = '无法生成二维码';
                }
                positionQrPopover(coords);
            }, 20);
        }
        function positionQrPopover(coords) {
            // Try to position relative to the hovered button if available so the popover doesn't overlap the title text
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const rect = qrPopover.getBoundingClientRect();
            const offset = 20; // 拉开一点，避免被悬停文字遮挡

            if (lastQrTarget) {
                const t = lastQrTarget.getBoundingClientRect();
                // Prefer to place popover to the right of the target
                let left = Math.round(t.right + offset);
                let top = Math.round(t.top + (t.height - rect.height) / 2);

                // If placing to the right would overflow, place to the left
                if (left + rect.width > vw - 20) {
                    left = Math.round(t.left - rect.width - offset);
                }

                // Clamp vertical position within viewport
                if (top < 10) top = 10;
                if (top + rect.height > vh - 20) top = vh - rect.height - 20;

                qrPopover.style.left = left + 'px';
                qrPopover.style.top = top + 'px';
                return;
            }

            if (!coords) return;
            // fallback to mouse coords
            let left = coords.x + offset;
            let top = coords.y + offset;
            if (left + rect.width > vw - 20) left = vw - rect.width - 20;
            if (top + rect.height > vh - 20) top = vh - rect.height - 20;
            qrPopover.style.left = left + 'px';
            qrPopover.style.top = top + 'px';
        }
        function hideQrPopover() {
            qrPopover.classList.add('hidden');
            qrPopover.innerHTML = '';
            lastQrTarget = null;
        }

        // 大二维码模态框
        function openQrModal(fileName, text) {
            const modal = document.getElementById('qrModal');
            const titleEl = document.getElementById('qrModalTitle');
            const contentEl = document.getElementById('qrModalContent');
            const textEl = document.getElementById('qrModalText');
            titleEl.textContent = fileName || '二维码';
            // 显示未转义的 URL 文本（用于可读显示），但生成二维码仍使用原始 text
            let displayText = text || '';
            try {
                displayText = decodeURI(displayText);
            } catch (e) {
                // 如果 decode 失败，保持原始文本
            }
            textEl.textContent = displayText;
            contentEl.innerHTML = '';
            const wrap = document.createElement('div');
            wrap.style.width = '320px';
            wrap.style.height = '320px';
            contentEl.appendChild(wrap);
            try {
                new QRCode(wrap, { text: text, width: 320, height: 320 });
            } catch (e) {
                wrap.textContent = '无法生成二维码';
            }
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
        function closeQrModal() {
            const modal = document.getElementById('qrModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        // 关闭模态框点击遮罩
        document.getElementById('qrModal').addEventListener('click', function (e) {
            if (e.target.id === 'qrModal') {
                closeQrModal();
            }
        });

        // 让 ESC 也能关闭 qr 模态
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeQrModal();
            }
        });

        // 注入二维码按钮到操作列（若表格由服务端渲染此部分可能重复，函数会检查避免重复注入）
        function injectQrButtons() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr'));
            rows.forEach(row => {
                // 找到已有的预览按钮或文件名
                let fname = null;
                const previewBtn = row.querySelector('button[data-filename]');
                if (previewBtn) fname = previewBtn.getAttribute('data-filename');
                if (!fname) {
                    const link = row.querySelector('a[data-filename]');
                    if (link) fname = link.getAttribute('data-filename');
                }
                if (!fname) {
                    const nameCell = row.querySelector('td');
                    if (nameCell) fname = nameCell.textContent.trim();
                }
                if (!fname) return;

                // 操作列为最后一个 td
                const tds = row.querySelectorAll('td');
                if (!tds || tds.length === 0) return;
                const opTd = tds[tds.length - 1];

                // 检查是否已存在 qr 按钮
                if (opTd.querySelector('button[data-qrcode]')) return;

                const btn = document.createElement('button');
                btn.setAttribute('type', 'button');
                // avoid native browser tooltip (title) which can overlap the QR popover
                // provide an accessible label instead
                btn.setAttribute('aria-label', '显示下载二维码');
                btn.setAttribute('data-qrcode', 'true');
                btn.setAttribute('data-filename', fname);
                btn.className = 'qr-btn ml-2';
                // svg 图标 (简化的二维码图标)
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3zM5 5v4h4V5zM13 3h8v8h-8zM15 5v4h4V5zM3 13h8v8H3zM5 15v4h4v-4zM11 11h2v2h-2zM17 11h2v2h-2zM11 17h2v2h-2zM17 17h2v2h-2zM11 13h2v2h-2z" /></svg>';

                // 点击打开大二维码
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const file = btn.getAttribute('data-filename');
                    // 构建下载链接文本（使用完整外部访问 URL）
                    const text = buildAbsoluteUrl(file);
                    openQrModal(file, text);
                });

                // 鼠标悬停处理通过事件委托（下面）也会触发，但为更好的移动可在按钮上也绑定 mouseenter/mouseleave
                opTd.appendChild(btn);
            });
        }

        // 委托处理悬停二维码
        tableBody.addEventListener('mouseover', e => {
            const qrBtn = e.target.closest('button[data-qrcode]');
            if (!qrBtn) return;
            const file = qrBtn.getAttribute('data-filename');
            if (!file) return;
            const text = buildAbsoluteUrl(file);
            startQrTimer(e, text, file);
        });
        tableBody.addEventListener('mouseout', e => {
            const qrBtn = e.target.closest('button[data-qrcode]');
            if (qrBtn) {
                cancelQrTimer();
                hideQrPopover();
            }
        });
        tableBody.addEventListener('mousemove', e => {
            if (!qrPopover.classList.contains('hidden')) {
                lastQrCoords = { x: e.pageX, y: e.pageY };
                positionQrPopover(lastQrCoords);
            }
        });

        // 在加载后注入按钮（如果 tableRows 是服务端渲染，这一步会在页面打开时加上二维码按钮）
        document.addEventListener('DOMContentLoaded', () => {
            injectQrButtons();
            // 如果表格有动态刷新逻辑，调用 injectQrButtons() 在刷新后再执行
        });
    </script>
</body>
</html>