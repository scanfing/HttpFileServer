<noscript>
 <strong>很抱歉，如果没有启用JavaScript，web将无法正常工作。请启用后继续。</strong>
 <strong>We're sorry but web doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
</noscript>
<!-- 拖拽上传模态框 -->
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
 <div class="theme-panel rounded-xl shadow-2xl w-full max-w-[70%] max-h-[80vh] mx-4 flex flex-col">
 <div class="px-6 py-3 border-b panel-border flex items-center justify-between">
 <h3 class="text-sm font-semibold text-primary">上传文件</h3>
 <button class="text-xs text-secondary hover:text-primary" onclick="cancel()">关闭</button>
 </div>
 <div class="flex-1 overflow-hidden flex flex-col">
 <div class="flex-1 overflow-auto">
 <table class="w-full divide-y text-xs" style="border-color: var(--panel-border)">
 <thead class="sticky top-0" style="background: var(--panel-bg)">
 <tr>
 <th class="px-3 py-2 text-left font-medium text-secondary">名称</th>
 <th class="px-3 py-2 text-left font-medium text-secondary">大小</th>
 <th class="px-3 py-2 text-left font-medium text-secondary">修改日期</th>
 <th class="px-3 py-2 text-left font-medium text-secondary">状态</th>
 </tr>
 </thead>
 <tbody id="fileInfo" class="divide-y" style="border-color: var(--panel-border)"></tbody>
 </table>
 </div>
 <div class="mt-2 p-2 text-center text-[11px]" style="background: var(--panel-border); color: var(--text)" id="overview"></div>
 </div>
 <div class="px-4 py-3 border-t panel-border flex justify-end space-x-2">
 <button id="confirm" class="hidden px-3 py-1 btn-accent rounded text-xs" onclick="confirmAndReload()">确定</button>
 <button id="cancel" class="hidden px-3 py-1 rounded text-xs" style="background: transparent; color: var(--text); border:1px solid var(--panel-border)" onclick="cancel()">取消</button>
 <button id="uploader" class="hidden px-3 py-1 btn-accent rounded text-xs" onclick="sendFiles()">开始上传</button>
 </div>
 </div>
</div>
<script>
 class ConcurrentUploadQueue {
 constructor(maxConcurrent=3){ this.maxConcurrent=maxConcurrent; this.running=0; this.queue=[]; this.completed=0; this.total=0; this.results=[]; this.errors=[]; this.onProgress=null; this.onComplete=null; this.onError=null; }
 addTask(uploadFunction, file, options={}){ return new Promise((resolve,reject)=>{ this.queue.push({ uploadFunction, file, options, resolve, reject }); this.total++; }); }
 startTask(){ this._next(); }
 _next(){ if(this.running>=this.maxConcurrent || this.queue.length===0) return; const task=this.queue.shift(); this.running++; this._updateProgress(); task.uploadFunction(task.file, task.options).then(result=>{ this.results.push({file:task.file,result,timestamp:new Date()}); task.resolve(result); }).catch(error=>{ this.errors.push({file:task.file,error,timestamp:new Date()}); task.reject(error); if(this.onError) this.onError(error, task.file); }).finally(()=>{ this.running--; this.completed++; this._updateProgress(); if(this.completed===this.total && this.running===0) this._onComplete(); this._next(); }); if(this.running<this.maxConcurrent && this.queue.length>0) this._next(); }
 _updateProgress(){ if(!this.onProgress) return; this.onProgress({ completed:this.completed, total:this.total, running:this.running, queued:this.queue.length, progress:this.total>0?(this.completed/this.total)*100:0 }); }
 _onComplete(){ if(this.onComplete) this.onComplete({results:this.results, errors:this.errors, total:this.total, completed:this.completed}); }
 setConcurrency(v){ this.maxConcurrent=v; while(this.running<this.maxConcurrent && this.queue.length>0) this._next(); }
 getStatus(){ return { running:this.running, queued:this.queue.length, completed:this.completed, total:this.total, progress:this.total>0?(this.completed/this.total)*100:0, results:this.results, errors:this.errors }; }
 clear(){ this.running=0; this.queue=[]; this.completed=0; this.total=0; this.results=[]; this.errors=[]; }
 }
 class UploadManager {
 constructor(){ this.uploadServer = window.location.pathname.endsWith('/')? window.location.pathname : window.location.pathname + '/'; this.queue=new ConcurrentUploadQueue(3); this.setupEventListeners(); this.onComplete=null; }
 // 修复上传：使用固定字段名 file，并附带 relativePath；进度用 xhr.upload.onprogress
 async simulateUpload(file, progressEle){ return new Promise((resolve,reject)=>{ const fd = new FormData(); const relPath = (file.fullPath || file.webkitRelativePath || file.name).replace(/^\\/,'').replace(/^\//,''); fd.append('file', file, file.name); fd.append('relativePath', relPath); const xhr = new XMLHttpRequest(); xhr.open('POST', this.uploadServer, true); xhr.onreadystatechange = function(){ if(xhr.readyState===4){ if(xhr.status===200){ progressEle && (progressEle.innerText='上传完毕'); try{ resolve(JSON.parse(xhr.responseText)); }catch{ resolve(xhr.responseText); } } else { progressEle && (progressEle.innerText='上传失败'); reject(new Error('HTTP '+xhr.status)); } } }; xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ const p = ((e.loaded/e.total)*100).toFixed(2); progressEle && (progressEle.innerText = `上传中：${p}%`); } }; xhr.onerror = ()=>{ progressEle && (progressEle.innerText='上传错误'); reject(new Error('Network error')); }; xhr.send(fd); }); }
 addFiles(files){ return new Promise(resolve=>{ for(const item of files){ this.queue.addTask(this.simulateUpload.bind(this), item.file, item.progressEle).then(()=>{}).catch(()=>{}); } resolve(); }); }
 setupEventListeners(){ this.queue.onProgress=(p)=>{ const overview=document.getElementById('overview'); if(overview) overview.innerText=`进度: ${p.completed}/${p.total} |运行中: ${p.running} | 等待中: ${p.queued}`; }; this.queue.onComplete=(s)=>{ this.onComplete && this.onComplete(s); }; this.queue.onError=(err,file)=>{ console.error('上传错误:', file && file.name, err); }; }
 clear(){ this.queue.clear(); const overview=document.getElementById('overview'); if(overview) overview.innerText=''; }
 }
 // 刷新确认：上传完成后点击“确定”刷新当前页面
 function confirmAndReload(){
 try{ document.querySelector('#uploadModal').classList.add('hidden'); }catch{}
 try{ uploadManager && uploadManager.clear && uploadManager.clear(); }catch{}
 window.location.reload();
 }
// ===== Upload UI logic (moved here so it's only present when uploads enabled) =====
let files = [];
const mainBody = document.querySelector('body');
const uploadManager = new UploadManager();

mainBody.addEventListener("dragover", e => e.preventDefault());
mainBody.addEventListener("dragleave", e => e.preventDefault());
mainBody.addEventListener("drop", dropHandle);

async function dropHandle(event) {
    event.preventDefault();
    const promises = [];

    for (const item of event.dataTransfer.items) {
        const entry = item.webkitGetAsEntry();
        promises.push(readFiles(entry));
    }

    const resultFilesArrays = await Promise.all(promises);
    files = resultFilesArrays.flat().reverse();

    let dataStr = files.map(file => `
                             <tr class='row-hover transition-colors'>
                             <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${file.fullPath}</td>
                             <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${getFileSize(file.size)}</td>
                             <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary'>${formatDate(file.lastModifiedDate)}</td>
                             <td class='px-6 py-4 whitespace-nowrap text-sm text-secondary uploadStatus'>待上传</td>
                             </tr>
                             `).join('');

    document.querySelector("#fileInfo").innerHTML = dataStr;
    const overview = document.getElementById('overview')
    overview.innerText = `文件总数：${files.length}`

    document.querySelector("#confirm").classList.add("hidden");
    document.querySelector("#cancel").classList.remove("hidden");
    document.querySelector("#uploader").classList.remove("hidden");
    document.querySelector("#uploadModal").classList.remove("hidden");
}
//读取文件/文件夹
async function readFiles(item) {
    if (item.isDirectory) {
        // 是一个文件夹
        const directoryReader = item.createReader();
        // readEntries是一个异步方法
        const entries = await new Promise((resolve, reject) => {
            directoryReader.readEntries(resolve, reject);
        });

        let files = [];
        for (const entry of entries) {
            const resultFiles = await readFiles(entry);
            files = files.concat(resultFiles);
        }
        return files;
    } else {
        // 是一个文件
        const file = await new Promise((resolve, reject) => {
            item.file(resolve, reject);
        });
        file.fullPath = item.fullPath;
        return [file];
    }
}

async function sendFiles() {
    if (!files.length) return;
    document.querySelector("#confirm").classList.add("hidden");
    document.querySelector("#cancel").classList.remove("hidden");
    document.querySelector("#uploader").classList.add("hidden");
    const statusBoxs = Array.from(document.querySelectorAll(".uploadStatus"));
    const fileItems = statusBoxs.map((e, i) => {
        return {
            file: files[i],
            progressEle: e,
        };
    });

    await uploadManager.addFiles(fileItems);
    uploadManager.queue.getStatus();
    uploadManager.queue.startTask();
    uploadManager.onComplete = (summary) => {
        files = [];
        document.querySelector("#confirm").classList.remove("hidden");
        document.querySelector("#cancel").classList.add("hidden");
        document.querySelector("#uploader").classList.add("hidden");
    };
}

function cancel() {
    files = [];
    document.querySelector("#uploadModal").classList.add("hidden");
    uploadManager.clear();
}

function getFileSize(srcLength) {
    let units = ["B", "KB", "MB", "GB"];
    var v = srcLength;
    var uIndex = 0;
    while (v > 1024 && uIndex < 3) {
        uIndex++;
        v /= 1024;
    }
    return `${Math.round(v * 100) / 100} ${units[uIndex]}`;
}

function formatDate(v) {
    var dt = new Date();
    if (v instanceof Date) dt = v;
    else if (v instanceof Number) {
        dt = new Date(v);
    }
    let num_year = dt.getFullYear();
    let num_month = dt.getMonth() + 1;
    let num_date = dt.getDate();
    let num_hour = dt.getHours();
    let num_min = dt.getMinutes();
    let num_sec = dt.getSeconds();

    return `${num_year}-${num_month < 10 ? "0" + num_month : num_month}-${num_date < 10 ? "0" + num_date : num_date
        } ${num_hour < 10 ? "0" + num_hour : num_hour}:${num_min < 10 ? "0" + num_min : num_min
        }:${num_sec < 10 ? "0" + num_sec : num_sec}`;

}
</script>